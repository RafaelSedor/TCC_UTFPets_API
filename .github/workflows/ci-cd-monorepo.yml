name: CI/CD Monorepo - UTFPets

on:
  push:
    branches:
      - master
      - main
  pull_request:
    branches:
      - master
      - main

env:
  PROJECT_ID: tccutfpets
  VM_NAME: tccutfpets
  VM_ZONE: southamerica-east1-b
  APP_DIR: /opt/utfpets
  BACKUP_DIR: /opt/utfpets_backups

jobs:
  # ==========================================
  # JOB 1: Testes do Backend (Laravel)
  # ==========================================
  test-backend:
    name: Backend Tests (Laravel)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: pdo, pdo_pgsql, mbstring, xml, bcmath, zip
          coverage: none

      - name: Copy .env.testing
        run: |
          cd backend
          cp .env.testing .env

      - name: Install Composer dependencies
        run: |
          cd backend
          composer install --prefer-dist --no-progress --no-interaction

      - name: Generate APP_KEY
        run: |
          cd backend
          php artisan key:generate

      - name: Run Backend Tests
        run: |
          cd backend
          php artisan test --parallel
        env:
          DB_CONNECTION: sqlite
          DB_DATABASE: ':memory:'

  # ==========================================
  # JOB 2: Testes do Frontend (Angular)
  # ==========================================
  test-frontend:
    name: Frontend Tests (Angular)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Run linting
        run: |
          cd frontend
          npm run lint || true

      - name: Run unit tests
        run: |
          cd frontend
          npm run test:ci

      - name: Build frontend (production)
        run: |
          cd frontend
          npm run build:prod

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist/
          retention-days: 1

  # ==========================================
  # JOB 3: Testes E2E (Selenium)
  # ==========================================
  test-e2e:
    name: E2E Tests (Selenium)
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Start services for E2E
        run: |
          docker compose -f docker-compose.e2e.yml up -d --build
          sleep 30

      - name: Run E2E Tests
        run: |
          docker compose -f docker-compose.e2e.yml run --rm e2e-tests

      - name: Stop services
        if: always()
        run: |
          docker compose -f docker-compose.e2e.yml down

  # ==========================================
  # JOB 4: Deploy to Production (GCP VM)
  # ==========================================
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Prepare deployment
        run: |
          echo "ğŸš€ Starting monorepo deployment to VM ${VM_NAME}..."
          echo "ğŸ“¦ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"

      - name: Install Docker on VM
        run: |
          echo "ğŸ”§ Installing Docker and preparing VM..."

          gcloud compute ssh ${VM_NAME} \
            --zone=${VM_ZONE} \
            --project=${PROJECT_ID} \
            --command="
              set -e

              echo 'ğŸ“¦ Checking Docker installation...'
              if ! command -v docker &> /dev/null; then
                echo 'Installing Docker Engine...'
                sudo apt-get update -qq
                sudo apt-get install -y ca-certificates curl
                sudo install -m 0755 -d /etc/apt/keyrings
                sudo curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc
                sudo chmod a+r /etc/apt/keyrings/docker.asc
                echo \"deb [arch=\$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian \$(. /etc/os-release && echo \\\"\$VERSION_CODENAME\\\") stable\" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
                sudo apt-get update -qq
                sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
                sudo usermod -aG docker \$USER
                echo 'âœ… Docker installed'
              else
                echo 'âœ… Docker already installed'
              fi

              echo 'ğŸ“ Creating directories...'
              sudo mkdir -p ${APP_DIR}
              sudo mkdir -p ${BACKUP_DIR}
              sudo chown \$USER:\$USER ${APP_DIR}
            "

      - name: Backup and stop containers
        run: |
          gcloud compute ssh ${VM_NAME} \
            --zone=${VM_ZONE} \
            --project=${PROJECT_ID} \
            --command="
              if [ -d ${APP_DIR} ] && [ \"\$(ls -A ${APP_DIR})\" ]; then
                echo 'â¸ï¸  Stopping containers...'
                cd ${APP_DIR}
                docker compose down || true

                echo 'ğŸ’¾ Creating backup...'
                BACKUP_NAME=utfpets_\$(date +%Y%m%d_%H%M%S)
                sudo cp -r ${APP_DIR} ${BACKUP_DIR}/\${BACKUP_NAME}
                echo \"âœ… Backup created: \${BACKUP_NAME}\"
              fi
            "

      - name: Copy monorepo files to VM
        run: |
          echo "ğŸ“ Copying monorepo files..."

          # Criar lista de exclusÃµes
          cat > /tmp/rsync-exclude.txt <<EOF
          .git
          .github
          **/node_modules
          **/vendor
          **/.env
          backend/storage/logs/*
          backend/storage/framework/cache/*
          backend/storage/framework/sessions/*
          backend/storage/framework/views/*
          backend/storage/keys/gcp-service-account.json
          backend/bootstrap/cache/*.php
          frontend/dist
          frontend/.angular
          tests/e2e/node_modules
          .gitignore
          .editorconfig
          EOF

          # Copiar todos os arquivos
          gcloud compute scp \
            --recurse \
            --zone=${VM_ZONE} \
            --project=${PROJECT_ID} \
            --compress \
            ./* ${VM_NAME}:${APP_DIR}/ \
            2>&1 | grep -v "Warning: Permanently added" || true

      - name: Create backend .env file
        run: |
          echo "ğŸ“ Creating backend .env file..."

          cat > /tmp/.env <<'EOF'
          APP_NAME="${{ secrets.APP_NAME || 'UTFPets API' }}"
          APP_ENV="${{ secrets.APP_ENV || 'production' }}"
          APP_KEY="${{ secrets.APP_KEY }}"
          APP_DEBUG="${{ secrets.APP_DEBUG || 'false' }}"
          APP_URL="${{ secrets.APP_URL || 'https://api.utfpets.online' }}"

          DB_CONNECTION="${{ secrets.DB_CONNECTION || 'pgsql' }}"
          DB_HOST="${{ secrets.DB_HOST }}"
          DB_PORT="${{ secrets.DB_PORT || '5432' }}"
          DB_DATABASE="${{ secrets.DB_DATABASE }}"
          DB_USERNAME="${{ secrets.DB_USERNAME }}"
          DB_PASSWORD="${{ secrets.DB_PASSWORD }}"

          JWT_SECRET="${{ secrets.JWT_SECRET }}"
          JWT_TTL="${{ secrets.JWT_TTL || '60' }}"

          CLOUDINARY_URL="${{ secrets.CLOUDINARY_URL }}"

          CLOUD_SQL_CONNECTION_NAME="${{ secrets.CLOUD_SQL_CONNECTION_NAME || 'tccutfpets:southamerica-east1:tcc' }}"
          EOF

          gcloud compute scp /tmp/.env ${VM_NAME}:${APP_DIR}/backend/.env \
            --zone=${VM_ZONE} \
            --project=${PROJECT_ID}

          rm /tmp/.env

      - name: Setup GCP service account
        run: |
          echo "ğŸ” Setting up GCP service account..."

          echo '${{ secrets.GCP_SA_KEY }}' > /tmp/gcp-sa-key.json

          gcloud compute ssh ${VM_NAME} \
            --zone=${VM_ZONE} \
            --project=${PROJECT_ID} \
            --command="
              sudo mkdir -p ${APP_DIR}/backend/storage/keys
              sudo rm -f ${APP_DIR}/backend/storage/keys/gcp-service-account.json
              sudo chown \$USER:\$USER ${APP_DIR}/backend/storage/keys
              sudo chmod 755 ${APP_DIR}/backend/storage/keys
            "

          gcloud compute scp /tmp/gcp-sa-key.json ${VM_NAME}:${APP_DIR}/backend/storage/keys/gcp-service-account.json \
            --zone=${VM_ZONE} \
            --project=${PROJECT_ID}

          gcloud compute ssh ${VM_NAME} \
            --zone=${VM_ZONE} \
            --project=${PROJECT_ID} \
            --command="
              chmod 600 ${APP_DIR}/backend/storage/keys/gcp-service-account.json
            "

          rm /tmp/gcp-sa-key.json

      - name: Build and start containers
        run: |
          echo "ğŸ³ Building and starting all containers..."

          gcloud compute ssh ${VM_NAME} \
            --zone=${VM_ZONE} \
            --project=${PROJECT_ID} \
            --command="
              set -e
              cd ${APP_DIR}

              echo 'ğŸ” Setting permissions...'
              sudo chown -R 1000:1000 backend/storage backend/bootstrap/cache 2>/dev/null || true
              sudo chmod -R 775 backend/storage backend/bootstrap/cache 2>/dev/null || true
              chmod +x backend/entrypoint.sh || true

              echo 'ğŸ” Fixing certbot permissions...'
              if [ -d certbot ]; then
                sudo chown -R \$USER:\$USER certbot/ 2>/dev/null || true
                sudo chmod -R 755 certbot/ 2>/dev/null || true
              fi

              echo 'ğŸ³ Building containers...'
              docker compose build

              echo 'ğŸš€ Starting containers...'
              docker compose up -d

              echo 'â³ Waiting for backend to be ready...'
              timeout 60 bash -c 'until docker compose exec -T backend php -r \"echo 1;\" 2>/dev/null; do echo \"Waiting...\"; sleep 2; done'

              echo 'ğŸ—ƒï¸  Running migrations...'
              docker compose exec -T backend php artisan migrate --force

              echo 'âš¡ Optimizing application...'
              docker compose exec -T backend php artisan config:cache || true
              docker compose exec -T backend php artisan route:cache || true
              docker compose exec -T backend php artisan view:cache || true

              echo 'ğŸ“Š Container status:'
              docker compose ps
            "

      - name: Health check
        run: |
          echo "ğŸ¥ Performing health checks..."

          MAX_ATTEMPTS=10
          ATTEMPT=0

          # Check backend
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Backend health check - Attempt $ATTEMPT/$MAX_ATTEMPTS..."

            if gcloud compute ssh ${VM_NAME} \
              --zone=${VM_ZONE} \
              --project=${PROJECT_ID} \
              --command="curl -f -s https://api.utfpets.online/api/health" > /dev/null 2>&1; then
              echo "âœ… Backend health check passed!"
              break
            fi

            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              sleep 5
            else
              echo "âŒ Backend health check failed"
              exit 1
            fi
          done

          # Check frontend
          ATTEMPT=0
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Frontend health check - Attempt $ATTEMPT/$MAX_ATTEMPTS..."

            if gcloud compute ssh ${VM_NAME} \
              --zone=${VM_ZONE} \
              --project=${PROJECT_ID} \
              --command="curl -f -s https://utfpets.online/health" > /dev/null 2>&1; then
              echo "âœ… Frontend health check passed!"
              exit 0
            fi

            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              sleep 5
            else
              echo "âŒ Frontend health check failed"
              exit 1
            fi
          done

      - name: Cleanup old backups
        if: success()
        run: |
          gcloud compute ssh ${VM_NAME} \
            --zone=${VM_ZONE} \
            --project=${PROJECT_ID} \
            --command="
              cd ${BACKUP_DIR}
              ls -dt utfpets_* 2>/dev/null | tail -n +6 | xargs sudo rm -rf || true
              echo \"âœ… Kept last 5 backups\"
            "

      - name: Deployment summary
        if: always()
        run: |
          echo "========================================="
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… DEPLOYMENT SUCCESSFUL!"
            echo "========================================="
            echo "ğŸŒ Frontend: https://utfpets.online"
            echo "ğŸ”Œ API: https://api.utfpets.online"
            echo "ğŸ“š Swagger: https://api.utfpets.online/swagger"
            echo "ğŸ’š Backend Health: https://api.utfpets.online/api/health"
            echo "ğŸ’š Frontend Health: https://utfpets.online/health"
            echo "========================================="
          else
            echo "âŒ DEPLOYMENT FAILED!"
            echo "========================================="
            exit 1
          fi
