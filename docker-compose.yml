services:
  # ========================================
  # Cloud SQL Proxy - Conex√£o segura com Google Cloud SQL
  # ========================================
  cloud-sql-proxy:
    image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.8.0
    container_name: utfpets-cloud-sql-proxy
    restart: unless-stopped
    command:
      - "--port=5432"
      - "--address=0.0.0.0"
      - "${CLOUD_SQL_CONNECTION_NAME}"
    volumes:
      - ./backend/storage/keys/gcp-service-account.json:/secrets/gcp-service-account.json:ro
    environment:
      - GOOGLE_APPLICATION_CREDENTIALS=/secrets/gcp-service-account.json
    ports:
      - "127.0.0.1:5432:5432"
    networks:
      - app-network
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 5432 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s  

  # ========================================
  # Backend - Laravel API
  # ========================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: utfpets-backend
    restart: unless-stopped
    environment:
      - APP_NAME=${APP_NAME}
      - APP_ENV=${APP_ENV}
      - APP_KEY=${APP_KEY}
      - APP_DEBUG=${APP_DEBUG}
      - APP_URL=${APP_URL}
      - CLOUD_SQL_CONNECTION_NAME=${CLOUD_SQL_CONNECTION_NAME}
      - DB_CONNECTION=${DB_CONNECTION}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_DATABASE=${DB_DATABASE}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_TTL=${JWT_TTL}
      - CLOUDINARY_URL=${CLOUDINARY_URL}
    volumes:
      - ./backend/storage:/var/www/storage
      - ./backend/bootstrap/cache:/var/www/bootstrap/cache
      - ./backend/storage/keys/gcp-service-account.json:/secrets/gcp-service-account.json:ro
    expose:
      - "9000"
    networks:
      - app-network
    depends_on:
      - cloud-sql-proxy
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 9000 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ========================================
  # Frontend - Angular PWA
  # ========================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - ENVIRONMENT=production
    container_name: utfpets-frontend
    restart: unless-stopped
    environment:
      - API_URL=${API_URL:-https://api.utfpets.online}
      - VAPID_PUBLIC_KEY=${VAPID_PUBLIC_KEY}
      - CLOUDINARY_CLOUD_NAME=${CLOUDINARY_CLOUD_NAME}
      - CLOUDINARY_UPLOAD_PRESET=${CLOUDINARY_UPLOAD_PRESET}
      - ENABLE_PWA=${ENABLE_PWA:-true}
      - ENABLE_NOTIFICATIONS=${ENABLE_NOTIFICATIONS:-true}
    volumes:
      - frontend-dist:/app/dist
      - ./frontend/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    expose:
      - "80"
    networks:
      - app-network
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O /dev/null http://localhost/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    depends_on:
      - backend

  # ========================================
  # Nginx - Reverse Proxy e Static Files
  # ========================================
  nginx:
    image: nginx:1.25-alpine
    container_name: utfpets-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      # Backend public files
      - ./backend/public:/var/www/backend/public:ro
      # Frontend static files (from frontend container)
      - frontend-dist:/usr/share/nginx/html:ro
      # Nginx configurations
      - ./nginx/utfpets.online.conf:/etc/nginx/conf.d/utfpets.conf:ro
      - ./nginx/api.utfpets.online.conf:/etc/nginx/conf.d/api.conf:ro
      # SSL certificates
      - ./certbot/conf:/etc/letsencrypt:ro
      - ./certbot/www:/var/www/certbot:ro
    depends_on:
      backend:
        condition: service_healthy
      frontend:
        condition: service_healthy
    networks:
      - app-network
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O /dev/null http://localhost/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ========================================
  # Certbot - SSL Certificate Management
  # ========================================
  certbot:
    image: certbot/certbot:latest
    container_name: utfpets-certbot
    restart: unless-stopped
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    networks:
      - app-network

  # ========================================
  # Swagger UI - API Documentation
  # ========================================
  swagger-ui:
    image: swaggerapi/swagger-ui:latest
    container_name: utfpets-swagger-ui
    restart: unless-stopped
    ports:
      - "127.0.0.1:8081:8080"
    environment:
      - URL=/api-docs.json
      - URLS_PRIMARY_NAME=UTFPets API
      - BASE_URL=/swagger
    depends_on:
      - nginx
    networks:
      - app-network
    security_opt:
      - no-new-privileges:true

# ========================================
# VOLUMES
# ========================================
volumes:
  frontend-dist:
    driver: local

# ========================================
# NETWORKS
# ========================================
networks:
  app-network:
    driver: bridge
